---
layout: post
title: "重定位条目和重定位算法"
tag: linux
category: essay
---

```c
typedef struct {
    long offset;		/* Offset of the reference to locate */
    long type:32,		/* Relocation type */
    	 symbol:32;		/* Symbol table index */
    long addend;		/* Constant part of relocation expression */
} Elf64_Rela;
```

重定位算法：

```c
foreach section s {
    foreach relocation entry r {
        refptr = s + r.offset;
            
        /* Relocate a PC-relative reference */
        if (r.type == R_X86_64_PC32) {
            refaddr = ADDR(s) + r.offset;
            *refptr = (unsigned) (ADDR(r.symbol) + r.addend - refaddr);
        }
        
        /* Relocate an absolute reference */
        if (r.type == R_X86_64_32) {
            *refptr = (unsigned) (ADDR(r.symbol) + r.addend);
        }
    }
}
```

